var mongodb=require('./db');
function Post(user,post,time){
    this.user=user;
    this.post=post;
    if(time){
        this.time=time;
    }else{
        this.time=new Date()
    }
}
module.exports=Post;
Post.prototype.save=function save(callback){
    var post={
        name:this.user.name,
        post:this.post,
        time:this.time,
    }
    mongodb.open(function(err,db){
        if(err){
            return callback(err);
        }
        db.collection('posts',function(err,collection){
            if(err){
                mongodb.close();
                return callback(err);
            }
            collection.ensureIndex('user');
            collection.insert(post,{safe:true},function(err,post){
                mongodb.close();
                callback(err,post);
            })
        })
    })
}
Post.get=function get(username,callback){
    // console.log("start")
    mongodb.open(function(err,db){
        if(err){
            return callback(err);
        }
        // console.log("2")
        db.collection('posts',function(err,collection){
            // console.log("3")
            if(err){
                mongodb.close();
                return callback(err);
            }
            // console.log("4")
            var query={};
            if(username){
                query.name=username;
            }
            // console.log(query)

            collection.find(query).toArray(function(err,docs){    
                mongodb.close();
                var posts=[]
                if(docs){
                    docs.forEach(function(doc,index){
                        var post=new Post(doc._id,doc.name,doc.post,doc.time)
                        posts.push(post);
                    })
                    // console.log(posts)
                    callback(null,posts)

                }
                else{
                    callback(err,null)
                }
      
     
            })
        })
    })
}
Post.del=function del(username,callback){
    mongodb.open(function(err,db){
        if(err){
            return callback(err);
        }
        db.collection('posts',function(err,collection){
            if(err){
                mongodb.close();
                return callback(err);
            }
            var query={};
            if(username){
                query.name=username;
            }
            console.log(query)

            collection.remove(query,function(err,result){    
                mongodb.close();
                console.log("删除成功")
                if(err){
                    console.log("error"+err);
                    return
                }
                callback(result)
               
   
            })
        })
    })
}

